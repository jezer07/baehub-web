<%
  currency_code = current_user.couple&.default_currency || CurrencyCatalog.default_code
  currency_symbol = CurrencyCatalog.symbol_for(currency_code)
%>

<%= form_with(model: settlement, local: true, class: "space-y-6") do |form| %>
  <% if settlement.errors.any? %>
    <div class="form-error-wrapper">
      <h3 class="form-error-title">
        <%= pluralize(settlement.errors.count, "error") %> prevented this settlement from being saved:
      </h3>
      <ul class="form-error-list">
        <% settlement.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>
  <div class="space-y-6">
    <%= form.hidden_field :payee_id, id: "settlement_payee_id", value: settlement.payer_id == current_user.id ? partner.id : current_user.id %>
    <div class="bg-blue-50 rounded-xl p-4 border border-blue-200">
      <label class="form-label">Who paid whom?</label>
      <div class="space-y-3">
        <label class="flex items-center p-3 bg-white rounded-xl border-2 border-neutral-300 cursor-pointer hover:border-primary-500 transition-all duration-200">
          <%= form.radio_button :payer_id, current_user.id, checked: settlement.payer_id == current_user.id, class: "form-radio" %>
          <span class="ml-3 text-sm font-medium text-neutral-900">
            I paid <%= partner.name %>
          </span>
        </label>
        <label class="flex items-center p-3 bg-white rounded-xl border-2 border-neutral-300 cursor-pointer hover:border-primary-500 transition-all duration-200">
          <%= form.radio_button :payer_id, partner.id, checked: settlement.payer_id == partner.id, class: "form-radio" %>
          <span class="ml-3 text-sm font-medium text-neutral-900">
            <%= partner.name %> paid me
          </span>
        </label>
      </div>
    </div>
    <script>
      (function() {
        const initializePayeeField = function() {
          const selectedPayer = document.querySelector('input[name="settlement[payer_id]"]:checked');
          if (selectedPayer) {
            selectedPayer.dispatchEvent(new Event('change'));
          }
        };

        document.querySelectorAll('input[name="settlement[payer_id]"]').forEach(radio => {
          radio.addEventListener('change', function() {
            const payeeField = document.querySelector('#settlement_payee_id');
            if (this.value === '<%= current_user.id %>') {
              payeeField.value = '<%= partner.id %>';
            } else {
              payeeField.value = '<%= current_user.id %>';
            }
          });
        });

        initializePayeeField();
        
        document.addEventListener('turbo:load', initializePayeeField);
      })();
    </script>
    <!-- Amount -->
    <div>
      <label for="settlement_amount_dollars" class="form-label">
        Amount
      </label>
      <div class="relative">
        <span id="settlement_currency_symbol" class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500 text-lg"><%= currency_symbol %></span>
        <%= form.number_field :amount_dollars,
            step: 0.01,
            placeholder: "0.00",
            class: "form-control w-full pl-8 pr-4 py-3 text-lg",
            required: true,
            min: 0.01 %>
      </div>
      <p class="form-help">Enter the payment amount in your shared currency.</p>
    </div>
    <!-- Date -->
    <div>
      <label for="settlement_settled_on" class="form-label">
        Date
      </label>
      <%= form.date_field :settled_on,
          class: "form-control w-full px-4 py-3",
          required: true %>
    </div>
    <!-- Notes (Optional) -->
    <div>
      <label for="settlement_notes" class="form-label">
        Notes <span class="text-neutral-400 font-normal">(optional)</span>
      </label>
      <%= form.text_area :notes,
          rows: 3,
          placeholder: "Add any notes about this payment...",
          class: "form-control w-full px-4 py-3" %>
    </div>
    <!-- Actions -->
    <div class="flex gap-3 pt-4">
      <%= form.submit settlement.new_record? ? "Record Payment" : "Update Payment",
          class: "btn-primary flex-1" %>
      <%= link_to "Cancel",
          expenses_path,
          class: "btn-secondary" %>
    </div>
  </div>
<% end %>
