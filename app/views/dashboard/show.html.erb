<div class="min-h-screen py-6 sm:py-8 relative z-0" data-controller="task-modal event-modal expense-modal">
  <div id="flash-messages"></div>
  <div class="max-w-6xl mx-auto px-4 sm:px-6 space-y-6 sm:space-y-8 relative z-10">

    <%# ── Invite Banner ── %>
    <% if @couple.users.size < 2 %>
      <div class="relative overflow-hidden rounded-2xl bg-gradient-to-r from-primary-600 via-primary-600 to-primary-500 text-white p-6 shadow-lg">
        <div class="absolute inset-0 bg-[url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iNjAiIGhlaWdodD0iNjAiIHZpZXdCb3g9IjAgMCA2MCA2MCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48ZyBmaWxsPSJub25lIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiPjxnIGZpbGw9IiNmZmZmZmYiIGZpbGwtb3BhY2l0eT0iMC4wNSI+PHBhdGggZD0iTTM2IDE4YzEuNjU3IDAgMyAxLjM0MyAzIDNzLTEuMzQzIDMtMyAzLTMtMS4zNDMtMy0zIDEuMzQzLTMgMy0zeiIvPjwvZz48L2c+PC9zdmc+')] opacity-50"></div>
        <div class="relative flex flex-col sm:flex-row gap-4 sm:items-center sm:justify-between">
          <div>
            <p class="font-semibold text-base mb-1">Waiting for your partner?</p>
            <p class="text-primary-100 text-sm">Share the invite code so they can join you here.</p>
          </div>
          <% if @active_invitations.any? %>
            <div class="flex flex-wrap gap-2">
              <% @active_invitations.each do |invitation| %>
                <span class="inline-flex items-center px-4 py-2 rounded-xl bg-white/15 backdrop-blur-sm font-mono text-sm tracking-widest border border-white/20"><%= invitation.code %></span>
              <% end %>
            </div>
          <% else %>
            <%= link_to "Generate invite", new_pairing_path, class: "inline-flex items-center justify-center px-5 py-2.5 rounded-xl bg-white text-primary-700 font-medium text-sm hover:bg-primary-50 transition-all shadow-sm w-full sm:w-auto" %>
          <% end %>
        </div>
      </div>
    <% end %>

    <%# ── Greeting Header ── %>
    <div class="flex flex-col sm:flex-row sm:items-end sm:justify-between gap-3">
      <div>
        <h1 class="text-2xl sm:text-3xl font-bold text-neutral-900 tracking-tight">
          Good <%= Time.current.hour < 12 ? 'morning' : Time.current.hour < 17 ? 'afternoon' : 'evening' %><%= current_user.name.present? ? ", #{current_user.name.split.first}" : '' %>
        </h1>
        <p class="text-sm text-neutral-500 mt-1"><%= Time.current.strftime("%A, %B %-d") %></p>
      </div>
      <div class="flex items-center gap-2">
        <button type="button" class="btn-secondary h-9 px-3 gap-1.5" data-action="click->task-modal#open">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" /></svg>
          Task
        </button>
        <button type="button" class="btn-secondary h-9 px-3 gap-1.5" data-action="click->event-modal#open">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" /></svg>
          Event
        </button>
        <button type="button" class="btn-secondary h-9 px-3 gap-1.5" data-action="click->expense-modal#open">
          <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" /></svg>
          Expense
        </button>
      </div>
    </div>

    <%# ── Main Grid ── %>
    <div class="grid lg:grid-cols-5 gap-4 sm:gap-6">

      <%# ── Tasks (takes 3 of 5 cols) ── %>
      <div class="lg:col-span-3 dashboard-card p-5 sm:p-6" data-controller="todo-filter">
        <div class="flex items-center justify-between mb-5">
          <div class="flex items-center gap-3">
            <div class="w-8 h-8 rounded-lg bg-primary-50 flex items-center justify-center">
              <svg class="w-4 h-4 text-primary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <div>
              <h2 class="section-header">Tasks</h2>
              <p class="section-subtitle">Your shared to-dos</p>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <button type="button"
                    class="text-xs text-neutral-400 hover:text-primary-600 transition-colors font-medium"
                    data-action="click->todo-filter#toggle"
                    data-todo-filter-target="toggleButton">
              Show completed
            </button>
            <%= link_to tasks_path, class: "text-xs text-neutral-400 hover:text-primary-600 transition-colors font-medium" do %>
              View all
            <% end %>
          </div>
        </div>

        <% if @tasks.any? %>
          <ul class="space-y-2">
            <% @tasks.each do |task| %>
              <%= render "tasks/task_item", task: task, compact: false, frame_id: "dashboard_task_#{task.id}" %>
            <% end %>
          </ul>
        <% else %>
          <div class="rounded-xl border border-dashed border-neutral-200 p-8 text-center">
            <div class="w-10 h-10 rounded-xl bg-neutral-100 flex items-center justify-center mx-auto mb-3">
              <svg class="w-5 h-5 text-neutral-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
            </div>
            <p class="text-sm text-neutral-500">No tasks yet.</p>
            <button type="button" class="text-sm text-primary-600 hover:text-primary-700 font-medium mt-1" data-action="click->task-modal#open">Add your first task</button>
          </div>
        <% end %>
      </div>

      <%# ── Right Column (Events + Finance) ── %>
      <div class="lg:col-span-2 space-y-4 sm:space-y-6">

        <%# ── Events Card ── %>
        <div class="dashboard-card p-5 sm:p-6">
          <div class="flex items-center justify-between mb-5">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-lg bg-secondary-50 flex items-center justify-center">
                <svg class="w-4 h-4 text-secondary-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" /></svg>
              </div>
              <h2 class="section-header">Events</h2>
            </div>
            <%= link_to events_path, class: "text-xs text-neutral-400 hover:text-primary-600 transition-colors font-medium" do %>
              View all
            <% end %>
          </div>

          <% if @events.any? %>
            <ul class="space-y-3">
              <% @events.each do |event| %>
                <%= render "events/event_item", event: event, show_link: true, compact: true %>
              <% end %>
            </ul>
          <% else %>
            <div class="rounded-xl border border-dashed border-neutral-200 p-6 text-center">
              <p class="text-sm text-neutral-500">No upcoming events.</p>
              <button type="button" class="text-sm text-primary-600 hover:text-primary-700 font-medium mt-1" data-action="click->event-modal#open">Add one</button>
            </div>
          <% end %>
        </div>

        <%# ── Bills & Balances Card ── %>
        <div class="dashboard-card p-5 sm:p-6">
          <div class="flex items-center justify-between mb-5">
            <div class="flex items-center gap-3">
              <div class="w-8 h-8 rounded-lg bg-accent-50 flex items-center justify-center">
                <svg class="w-4 h-4 text-accent-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" /></svg>
              </div>
              <h2 class="section-header">Finances</h2>
            </div>
            <%= link_to expenses_path, class: "text-xs text-neutral-400 hover:text-primary-600 transition-colors font-medium" do %>
              View all
            <% end %>
          </div>

          <%= render "expenses/balance_summary", balance_data: @balance_data, couple: @couple %>

          <% if @expenses.any? %>
            <div class="mt-4 pt-4 border-t border-neutral-100">
              <p class="text-xs font-medium text-neutral-400 uppercase tracking-wider mb-3">Recent expenses</p>
              <div class="space-y-0">
                <% @expenses.each do |expense| %>
                  <%= render "expenses/expense_item", expense: expense, show_link: true, compact: true %>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <%# ── Activity Timeline ── %>
    <div class="dashboard-card p-5 sm:p-6">
      <div class="flex items-center justify-between mb-6">
        <div class="flex items-center gap-3">
          <div class="w-8 h-8 rounded-lg bg-neutral-100 flex items-center justify-center">
            <svg class="w-4 h-4 text-neutral-600" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6v6h4.5m4.5 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
          </div>
          <h2 class="section-header">Activity</h2>
        </div>
      </div>

      <% if @activity_logs.any? %>
        <div class="space-y-0">
          <% @activity_logs.each do |log| %>
            <div class="timeline-item">
              <%= activity_log_icon(log) %>

              <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-1">
                <div>
                  <p class="text-sm text-neutral-800">
                    <span class="font-medium"><%= log.action %></span>
                    <% if log.subject_type == 'Task' && log.subject.nil? %>
                      <span class="text-neutral-400">(deleted)</span>
                    <% elsif log.subject_type == 'Event' && log.subject.nil? %>
                      <span class="text-neutral-400">(deleted)</span>
                    <% elsif log.subject_type == 'EventResponse' && log.subject&.event.present? %>
                      <%= link_to log.subject.event.title, event_path(log.subject.event), class: "text-primary-600 hover:text-primary-700 font-medium ml-0.5" %>
                    <% end %>
                    <% if log.user %>
                      <span class="text-neutral-400 font-normal"> &middot; <%= log.user == current_user ? "you" : log.user.name %></span>
                    <% end %>
                  </p>
                </div>
                <span class="text-xs text-neutral-400 flex-shrink-0"><%= time_ago_in_words(log.created_at) %> ago</span>
              </div>
            </div>
          <% end %>
        </div>
      <% else %>
        <div class="text-center py-6">
          <p class="text-sm text-neutral-500">No activity yet. Complete a task, add an event, or invite your partner to get started.</p>
        </div>
      <% end %>
    </div>
  </div>

  <%# ── Task Modal ── %>
  <div class="fixed inset-0 bg-black/40 backdrop-blur-sm z-30 hidden opacity-0 transition-opacity duration-300 pointer-events-none" data-task-modal-target="backdrop" data-action="click->task-modal#close"></div>
  <div class="fixed top-0 right-0 h-full w-full md:w-2/3 lg:w-1/2 bg-white shadow-elevated z-50 transform translate-x-full transition-transform duration-300 hidden overflow-y-auto border-l border-neutral-200/50" data-task-modal-target="modal">
    <div class="sticky top-0 bg-white/80 backdrop-blur-xl border-b border-neutral-100 px-6 py-4 flex justify-between items-center z-10">
      <h2 class="text-lg font-semibold text-neutral-900">New task</h2>
      <button type="button" class="p-1.5 rounded-lg text-neutral-400 hover:text-neutral-600 hover:bg-neutral-100 transition-all" data-action="click->task-modal#close">
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
    </div>
    <div class="p-6">
      <% quick_task = current_user.couple.tasks.build(creator: current_user) %>
      <%= render "tasks/form", task: quick_task, redirect_to: dashboard_path %>
    </div>
  </div>

  <%# ── Event Modal ── %>
  <div class="fixed inset-0 bg-black/40 backdrop-blur-sm z-30 hidden opacity-0 transition-opacity duration-300 pointer-events-none" data-event-modal-target="backdrop" data-action="click->event-modal#close"></div>
  <div class="fixed top-0 right-0 h-full w-full md:w-2/3 lg:w-1/2 bg-white shadow-elevated z-50 transform translate-x-full transition-transform duration-300 hidden overflow-y-auto border-l border-neutral-200/50" data-event-modal-target="modal">
    <div class="sticky top-0 bg-white/80 backdrop-blur-xl border-b border-neutral-100 px-6 py-4 flex justify-between items-center z-10">
      <h2 class="text-lg font-semibold text-neutral-900">New event</h2>
      <button type="button" class="p-1.5 rounded-lg text-neutral-400 hover:text-neutral-600 hover:bg-neutral-100 transition-all" data-action="click->event-modal#close">
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
    </div>
    <div class="p-6">
      <% quick_event = current_user.couple.events.build(creator: current_user) %>
      <%= render "events/form", event: quick_event %>
    </div>
  </div>

  <%# ── Expense Modal ── %>
  <div class="fixed inset-0 bg-black/40 backdrop-blur-sm z-30 hidden opacity-0 transition-opacity duration-300 pointer-events-none" data-expense-modal-target="backdrop" data-action="click->expense-modal#close"></div>
  <div class="fixed top-0 right-0 h-full w-full md:w-2/3 lg:w-1/2 bg-white shadow-elevated z-50 transform translate-x-full transition-transform duration-300 hidden overflow-y-auto border-l border-neutral-200/50" data-expense-modal-target="modal">
    <div class="sticky top-0 bg-white/80 backdrop-blur-xl border-b border-neutral-100 px-6 py-4 flex justify-between items-center z-10">
      <h2 class="text-lg font-semibold text-neutral-900">New expense</h2>
      <button type="button" class="p-1.5 rounded-lg text-neutral-400 hover:text-neutral-600 hover:bg-neutral-100 transition-all" data-action="click->expense-modal#close">
        <svg class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
      </button>
    </div>
    <div class="p-6">
      <% quick_expense = current_user.couple.expenses.build(spender: current_user, incurred_on: Date.today) %>
      <% couple_users = current_user.couple.users.to_a %>
      <%= render "expenses/form", expense: quick_expense, couple_users: couple_users %>
    </div>
  </div>
</div>
