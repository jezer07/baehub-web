<%
  balance_data ||= local_assigns[:balance_data]
  couple ||= local_assigns[:couple]
%>

<% if balance_data[:summary].any? %>
  <div class="space-y-3">
    <% balance_data[:summary].each do |summary_item| %>
      <%
        debtor = summary_item[:debtor]
        creditor = summary_item[:creditor]
        amount_cents = summary_item[:amount_cents]
        currency_code = couple&.default_currency || CurrencyCatalog.default_code
        currency_symbol = CurrencyCatalog.symbol_for(currency_code)
        formatted_amount = "#{currency_symbol}#{'%.2f' % (amount_cents / 100.0)}"
      %>
      <div class="rounded-xl bg-neutral-50 border border-neutral-200/60 px-4 py-3">
        <div class="flex items-center justify-between gap-3">
          <div class="flex items-center gap-2.5 min-w-0">
            <%= user_avatar(debtor, size: 'small') %>
            <p class="text-sm text-neutral-700 min-w-0">
              <% if debtor == current_user %>
                You owe <span class="font-medium"><%= user_display_name(creditor) %></span>
              <% else %>
                <span class="font-medium"><%= user_display_name(debtor) %></span> owes you
              <% end %>
            </p>
          </div>
          <p class="text-base font-bold text-neutral-900 flex-shrink-0"><%= formatted_amount %></p>
        </div>
      </div>
    <% end %>

    <% first_summary = balance_data[:summary].first %>
    <%
      debtor = first_summary[:debtor]
      creditor = first_summary[:creditor]
      amount_dollars = (first_summary[:amount_cents] / 100.0).round(2)

      if debtor == current_user
        button_text = "Settle up"
      else
        button_text = "Record payment"
      end
    %>

    <%= link_to button_text,
        new_settlement_path(
          payer_id: debtor.id,
          payee_id: creditor.id,
          amount: format('%.2f', amount_dollars)
        ),
        class: "inline-flex w-full justify-center items-center gap-2 bg-primary-600 text-white px-4 py-2.5 rounded-xl text-sm font-medium hover:bg-primary-700 transition-all shadow-sm" %>
  </div>
<% else %>
  <div class="rounded-xl bg-success-50 border border-success-200 px-4 py-3 text-center">
    <p class="text-sm font-medium text-success-700">All settled up</p>
    <p class="text-xs text-success-600 mt-0.5">No outstanding balances</p>
  </div>
<% end %>
