<%
  balance_data ||= local_assigns[:balance_data]
  couple ||= local_assigns[:couple]
%>

<div class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-2xl border border-blue-200 p-6 mb-6">
  <div class="mb-4">
    <h3 class="text-lg font-semibold text-blue-900">Current Balance</h3>
    <p class="text-sm text-blue-700">Your current balance after all expenses and payments</p>
  </div>

  <% if balance_data[:summary].any? %>
    <div class="space-y-3">
      <% balance_data[:summary].each do |summary_item| %>
        <% 
          currency = summary_item[:currency]
          debtor = summary_item[:debtor]
          creditor = summary_item[:creditor]
          amount_cents = summary_item[:amount_cents]
          formatted_amount = Expense.new(amount_cents: amount_cents, currency: currency).formatted_amount
        %>
        <div class="flex items-center justify-between p-4 bg-white rounded-xl border border-blue-200">
          <div class="flex items-center gap-3 flex-1">
            <%= user_avatar(debtor, size: 'small') %>
            <div class="flex-1">
              <div class="font-medium text-neutral-900">
                <% if debtor == current_user %>
                  You owe <%= user_display_name(creditor) %>
                <% else %>
                  <%= user_display_name(debtor) %> owes you
                <% end %>
                <div class="text-xl font-bold text-blue-900"><%= formatted_amount %></div>
              </div>
            </div>
          </div>
         </div>
      <% end %>
    </div>
    
    <% first_summary = balance_data[:summary].first %>
    <div class="mt-6 text-center">
      <% 
        debtor = first_summary[:debtor]
        creditor = first_summary[:creditor]
        amount_dollars = (first_summary[:amount_cents] / 100.0).round(2)
        currency = first_summary[:currency]
        
        if debtor == current_user
          button_text = "Settle Up - Pay #{user_display_name(creditor)}"
        else
          button_text = "Settle Up - Record Payment"
        end
      %>
      
      <%= link_to button_text,
          new_settlement_path(
            payer_id: debtor.id,
            payee_id: creditor.id,
            amount: format('%.2f', amount_dollars),
            currency: currency
          ),
          class: "inline-flex items-center gap-2 bg-gradient-to-r from-green-600 to-green-700 text-white px-6 py-3 rounded-xl font-semibold hover:from-green-700 hover:to-green-800 transition-all shadow-lg" %>
      
      <% if balance_data[:summary].count > 1 %>
        <p class="text-xs text-blue-600 mt-2">Settle <%= currency %> balance</p>
      <% end %>
    </div>
  <% else %>
    <div class="text-center py-4">
      <p class="text-success-700 font-medium">All settled up! ðŸŽ‰</p>
      <p class="text-sm text-success-600 mt-1">No outstanding balances</p>
    </div>
  <% end %>
</div>

