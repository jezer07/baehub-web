<%
  currency_code = current_user.couple&.default_currency || CurrencyCatalog.default_code
  currency_symbol_map = { currency_code => CurrencyCatalog.symbol_for(currency_code) }
  initial_currency_symbol = currency_symbol_map[currency_code]
%>

<%= form_with model: expense,
              class: "space-y-5",
              data: {
                controller: "expense-form",
                expense_form_currency_symbols_value: currency_symbol_map.to_json,
                expense_form_default_currency_value: currency_code
              } do |f| %>
  <% if expense.errors.any? %>
    <div class="form-error-wrapper">
      <h3 class="form-error-title">
        <%= pluralize(expense.errors.count, "error") %> prevented this expense from being saved:
      </h3>
      <ul class="form-error-list">
        <% expense.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div>
    <%= f.label :title, "Expense title", class: "form-label" %>
    <%= f.text_field :title, autofocus: true, placeholder: "e.g., Dinner at restaurant", class: "form-control w-full px-4 py-3" %>
  </div>

  <div>
    <%= f.label :amount, "Amount", class: "form-label" %>
    <div class="flex gap-3">
      <div class="relative flex-1">
        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-neutral-500 text-lg"><%= initial_currency_symbol %></span>
        <%= f.number_field :amount, value: expense.amount_cents ? (expense.amount_cents / 100.0) : nil, step: 0.01, min: 0.01, required: true, class: "form-control w-full pl-8 pr-4 py-3", placeholder: "0.00", data: { expense_form_target: "amountInput", action: "input->expense-form#convertAmountToCents" } %>
      </div>
      <%= f.hidden_field :amount_cents, data: { expense_form_target: "amountCentsInput" } %>
    </div>
  </div>

  <div>
    <%= f.label :incurred_on, "Date incurred", class: "form-label" %>
    <%= f.date_field :incurred_on, value: expense.incurred_on || Date.today, required: true, class: "form-control w-full px-4 py-3" %>
  </div>

  <div>
    <%= f.label :notes, "Notes (optional)", class: "form-label" %>
    <%= f.text_area :notes, rows: 3, placeholder: "Add any additional details", class: "form-control w-full px-4 py-3" %>
  </div>

  <div>
    <%= f.label :spender_id, "Paid by", class: "form-label" %>
    <%= f.collection_select :spender_id, couple_users, :id, ->(user) { user_display_name(user) }, { selected: expense.spender_id || current_user.id }, class: "form-control w-full px-4 py-3" %>
  </div>

  <div>
    <%= f.label :split_strategy, "How to split this expense?", class: "form-label" %>
    <div class="space-y-3">
      <label class="flex items-start gap-3 p-4 rounded-xl border border-neutral-300 hover:bg-neutral-50 cursor-pointer transition-all duration-200">
        <%= f.radio_button :split_strategy, "equal", checked: expense.split_strategy.nil? || expense.split_strategy == "equal", class: "form-radio mt-1", data: { action: "change->expense-form#updateSplitFields" } %>
        <div class="flex-1">
          <div class="font-medium text-neutral-900">Split equally</div>
          <div class="text-sm text-neutral-600">Split equally between both of you</div>
        </div>
      </label>

      <label class="flex items-start gap-3 p-4 rounded-xl border border-neutral-300 hover:bg-neutral-50 cursor-pointer transition-all duration-200">
        <%= f.radio_button :split_strategy, "percentage", class: "form-radio mt-1", data: { action: "change->expense-form#updateSplitFields" } %>
        <div class="flex-1">
          <div class="font-medium text-neutral-900">Split by percentage</div>
          <div class="text-sm text-neutral-600">Split by percentage</div>
        </div>
      </label>

      <label class="flex items-start gap-3 p-4 rounded-xl border border-neutral-300 hover:bg-neutral-50 cursor-pointer transition-all duration-200">
        <%= f.radio_button :split_strategy, "custom_amounts", class: "form-radio mt-1", data: { action: "change->expense-form#updateSplitFields" } %>
        <div class="flex-1">
          <div class="font-medium text-neutral-900">Split by custom amounts</div>
          <div class="text-sm text-neutral-600">Split by custom amounts</div>
        </div>
      </label>
    </div>
  </div>

  <div data-expense-form-target="splitFields" class="space-y-4">
    <div data-expense-form-target="equalFields" class="<%= 'hidden' unless expense.split_strategy.nil? || expense.split_strategy == 'equal' %>">
      <div class="bg-primary-50 rounded-xl p-4 border border-primary-200">
        <p class="text-sm text-primary-900 mb-2">The expense will be divided equally between both users</p>
        <div class="text-sm font-medium text-primary-800" data-expense-form-target="equalSplitDisplay">
          Each person owes: <span data-expense-form-target="equalAmount"><%= "#{initial_currency_symbol}0.00" %></span>
        </div>
      </div>
    </div>

    <div data-expense-form-target="percentageFields" class="<%= 'hidden' unless expense.split_strategy == 'percentage' %> space-y-4">
      <p class="form-hint mb-3">Percentages must add up to 100%</p>
      <% couple_users.each_with_index do |user, index| %>
        <%= f.fields_for :shares, index: index do |share_fields| %>
          <%= share_fields.hidden_field :user_id, value: user.id %>
          <div>
            <%= share_fields.label :percentage, user_display_name(user), class: "form-label" %>
            <div class="flex items-center gap-3">
              <%= share_fields.number_field :percentage, min: 0, max: 100, step: 0.01, placeholder: "50", class: "form-control flex-1 px-4 py-3", data: { action: "input->expense-form#validatePercentages" } %>
              <span class="text-neutral-600">%</span>
            </div>
            <p class="form-help">Amount: <span data-expense-form-target="percentageAmount"><%= "#{initial_currency_symbol}0.00" %></span></p>
          </div>
        <% end %>
      <% end %>
      <div data-expense-form-target="percentageValidation" class="hidden">
        <p class="text-sm text-error-600"></p>
      </div>
    </div>

    <div data-expense-form-target="customAmountsFields" class="<%= 'hidden' unless expense.split_strategy == 'custom_amounts' %> space-y-4">
      <p class="form-hint mb-3">Amounts must add up to total expense</p>
      <% couple_users.each_with_index do |user, index| %>
        <%= f.fields_for :shares, index: index do |share_fields| %>
          <%= share_fields.hidden_field :user_id, value: user.id %>
          <div>
            <%= share_fields.label :amount, user_display_name(user), class: "form-label" %>
            <div class="flex items-center gap-3">
              <span class="text-neutral-600" data-expense-form-target="customAmountPrefix"><%= initial_currency_symbol %></span>
              <%= share_fields.number_field :amount, min: 0, step: 0.01, placeholder: "0.00", class: "form-control flex-1 px-4 py-3", data: { action: "input->expense-form#validateCustomAmounts" } %>
            </div>
          </div>
        <% end %>
      <% end %>
      <div data-expense-form-target="customAmountsValidation" class="hidden">
        <p class="text-sm text-error-600"></p>
      </div>
    </div>
  </div>

  <div class="flex justify-end pt-4">
    <%= f.submit class: "btn-primary", data: { expense_form_target: "submitButton" } %>
  </div>
<% end %>
